{"title":":orange_book: Malaria case study - Part 1","markdown":{"yaml":{"title":":orange_book: Malaria case study - Part 1","warning":false},"headingText":"Introduction","containsRefs":false,"markdown":"\n\n\n### Overview\n\nThese pages will demonstrate how to use Quarto to data from Tanzania.\n\n### Learning objectives\n\n-   Apply what you have learnt on Day 1 on real data\n\n## Getting started\n\n### Access the Quarto template\n\nDownload the Quarto template used for this case study (add link) using GitHub.\n\nPlease review previous sections on Quarto, data import and manipulation.\n\n### Install packages\n\n``` {{r}}\ninstall.packages(\"ggplot2\")\ninstall.packages(\"ggthemes\")\ninstall.packages(\"networkD3\")\ninstall.packages(\"apyramid\")\n```\n\n```{r}\n#| echo: fenced\nlibrary(openxlsx)\nlibrary(tidyverse)\nlibrary(skimr)\nlibrary(DataExplorer)\nlibrary(gtsummary)\nlibrary(finalfit)\nlibrary(ggplot2)\nlibrary(ggthemes)\nlibrary(networkD3) # For alluvial/Sankey diagrams\n```\n\n### Import the data\n\n::: panel-tabset\n#### :pencil2: Exercise 1\n\nImport the dataset and store it into a dataframe called **df**. Display the first 5 rows and columns `child_ID`, `CTX_month`, `CTX_district`, `SDC_age_in_months`\n\n::: callout-tip\nRefer to @sec-import-data-from-files\n:::\n\n```{r}\n#| echo: fenced\n# Write your code here\n```\n\n#### Stata\n\n```{r}\n#| echo: fenced\nstata_df <- haven::read_dta(\"./data/dataset2.dta\")\n```\n\n```{r}\n#| echo: fenced\n#| df-print: kable\nstata_df %>%\n  head(5) %>%\n  dplyr::select(child_ID,\n                CTX_month,\n                CTX_district,\n                SDC_age_in_months) %>%\n  knitr::kable()\n```\n\n#### R\n\n```{r}\n#| echo: fenced\ndf <- openxlsx::read.xlsx(\"./data/dataset2.xlsx\")\n```\n\n```{r}\n#| echo: fenced\n#| df-print: kable\ndf %>%\n  head(5) %>%\n  dplyr::select(child_ID,\n                CTX_month,\n                CTX_district,\n                SDC_age_in_months) %>%\n  knitr::kable()\n```\n:::\n\n## Population characteristics\n\n### Codebook\n\n+-----------------------------+---------------+\n| Variable                    | Coding        |\n+=============================+===============+\n| SDC_age_in_months           |               |\n+-----------------------------+---------------+\n| SDC_sex                     | 1: male\\      |\n|                             | 2: female\\    |\n|                             | 98: unknown   |\n+-----------------------------+---------------+\n| CLIN_fever                  | 0: no\\        |\n|                             | 1: yes\\       |\n|                             | 98: not sure  |\n+-----------------------------+---------------+\n| CLIN_fever_onset            |               |\n+-----------------------------+---------------+\n| CLIN_cough                  | 0: no\\        |\n|                             | 1: yes\\       |\n|                             | 98: not sure  |\n+-----------------------------+---------------+\n| CLIN_diarrhoea              | 0: no\\        |\n|                             | 1: yes\\       |\n|                             | 98: not sure  |\n+-----------------------------+---------------+\n| RX_preconsult_antibiotics   |               |\n+-----------------------------+---------------+\n| RX_preconsult_antimalarials |               |\n+-----------------------------+---------------+\n| CTX_district                | Kaliua\\       |\n|                             | Sengerema\\    |\n|                             | Tanga         |\n+-----------------------------+---------------+\n| CTX_area                    | Urban\\        |\n|                             | rural         |\n+-----------------------------+---------------+\n| CTX_facility_type           | Dispensary\\   |\n|                             | Health centre |\n+-----------------------------+---------------+\n\n### Structure of the data\n\n::: panel-tabset\n#### :pencil2: Exercise 2\n\nExamine the structure of the data, including variable names, labels.\n\n::: callout-tip\n-   Stata: use the [codebook](https://www.stata.com/manuals/dcodebook.pdf) command\n-   R: use the [skim](https://docs.ropensci.org/skimr/reference/skim.html) function from the `skimr` package\n:::\n\n```{r}\n#| echo: fenced\n# Write your code here\n```\n\n#### Stata\n\n```{r}\n#| echo: fenced\nRStata::stata(\"codebook SDC_age_in_months SDC_sex CLIN_fever CLIN_fever_onset CLIN_diarrhoea CLIN_cough RX_preconsult_antibiotics RX_preconsult_antimalarials CTX_district CTX_area CTX_facility_type\",\n              data.in = stata_df)\n```\n\n#### R\n\n```{r}\n#| echo: fenced\ndf %>%\n  skim(SDC_age_in_months,\n       SDC_sex,\n       CLIN_fever,\n       CLIN_fever_onset,\n       CLIN_diarrhoea,\n       CLIN_cough,\n       RX_preconsult_antibiotics,\n       RX_preconsult_antimalarials,\n       CTX_district,\n       CTX_area,\n       CTX_facility_type)\n```\n```{r}\n#| echo: fenced\ndf <- df %>%\n  tibble::remove_rownames() %>%\n  tibble::column_to_rownames(var=\"child_ID\") %>% \n  dplyr::mutate(across(c(SDC_sex, \n                         CLIN_fever,\n                         CLIN_cough,\n                         CLIN_diarrhoea,\n                         RX_preconsult_antibiotics,\n                         RX_preconsult_antimalarials,\n                         CTX_district,\n                         CTX_area,\n                         CTX_facility_type),\n                       factor))\n```\n\n:::\n\n#### Identify missing values\n\nIdentify missing values in each variable\n\n```{r}\n#| fig.height: 10\nDataExplorer::plot_missing(df,\n                           geom_label_args = list(size = 2, label.padding = unit(0.2, \"lines\")))\n```\n\n```{r}\nDataExplorer::plot_bar(df %>% \n                         dplyr::select(-CTX_facility_ID),\n                       by = \"CTX_district\")\n```\n\n::: panel-tabset\n#### :pencil2: Exercise 3\n\nAdd the following two new variables to data frame `df`\n\n+---------------------------+---------------+\n| Variable                  | Coding        |\n+===========================+===============+\n| SDC_age_category          | \\<2 months\\   |\n|                           | 2-11 months\\  |\n|                           | 12-23 months\\ |\n|                           | 24-35 months\\ |\n|                           | 36-47 months\\ |\n|                           | 48-59 months  |\n+---------------------------+---------------+\n| CLIN_fever_onset_category | \\<2 days\\     |\n|                           | 2-3 days\\     |\n|                           | 4-6 days\\     |\n|                           | â‰¥7 days       |\n+---------------------------+---------------+\n\n::: callout-tip\n-   Stata: use the gen command\n-   R: use the [mutate](https://dplyr.tidyverse.org/reference/mutate.html) and [case_when](https://dplyr.tidyverse.org/reference/case_when.html) functions from the `dplyr` package\n:::\n\n```{r}\n#| echo: fenced\n# Write your code here\n```\n\n#### Stata\n\n#### R\n\n```{r}\n#| echo: fenced\ndf <- df %>%\n  dplyr::mutate(\n    SDC_age_category = dplyr::case_when(\n      SDC_age_in_months < 2 ~ \"<2 months\",\n      SDC_age_in_months >= 2 & SDC_age_in_months < 12 ~ \"02-11 months\",\n      SDC_age_in_months >= 12 & SDC_age_in_months < 24 ~ \"12-23 months\",\n      SDC_age_in_months >= 24 & SDC_age_in_months < 36 ~ \"24-35 months\",\n      SDC_age_in_months >= 36 & SDC_age_in_months < 48 ~ \"36-47 months\",\n      SDC_age_in_months >= 48 & SDC_age_in_months < 60 ~ \"48-59 months\",\n      TRUE ~ \"\"\n    )\n  ) %>% \n  dplyr::mutate(\n    CLIN_fever_onset_category = dplyr::case_when(\n      CLIN_fever_onset < 2 ~ \"<2 days\",\n      CLIN_fever_onset >= 2 & CLIN_fever_onset < 4 ~ \"2-3 days\",\n      CLIN_fever_onset >= 4 & CLIN_fever_onset < 7 ~ \"4-6 days\",\n      CLIN_fever_onset >= 7 ~ \">= 7 days\",\n      TRUE ~ \"\"\n    )\n  )\n```\n\n#### Python\n:::\n\n::: panel-tabset\n#### :pencil2: Exercise 4\n\nDisplay descriptive statistics for the following population characteristics:\n\n::: callout-tip\n-   Stata\n-   R: use the [tbl_summary](https://www.danieldsjoberg.com/gtsummary/reference/tbl_summary.html) function from the `gtsummary` package\n:::\n\n```{r}\n#| echo: fenced\n# Write your code here\n```\n\n#### Stata\n\n```{r}\n#| echo: fenced\nRStata::stata('tabulate SDC_age_category\n              tabulate SDC_sex\n              tabulate CLIN_fever\n              tabulate CLIN_fever_onset_category\n              tabulate CLIN_diarrhoea\n              tabulate CLIN_cough\n              tabulate RX_preconsult_antibiotics\n              tabulate RX_preconsult_antimalarials\n              tabulate CTX_district\n              tabulate CTX_area\n              tabulate CTX_facility_type',\n              data.in = stata_df)\n```\n\n#### R\n\n```{r}\n#| echo: fenced\ndf %>%\n  dplyr::select(SDC_age_category,\n                SDC_sex,\n                CLIN_fever,\n                CLIN_fever_onset_category,\n                CLIN_diarrhoea,\n                CLIN_cough,\n                RX_preconsult_antibiotics,\n                RX_preconsult_antimalarials,\n                CTX_district,\n                CTX_area,\n                CTX_facility_type) %>%\n  gtsummary::tbl_summary(missing_text = \"(Missing)\")\n```\n:::\n\n## Healthcare provider actions\n\n### Codebook\n\n-   Temperature measured\n    -   Fever measured\n-   Fever (temp or history)\n-   Malaria test\n-   Any severe diagnosis\n-   Malaria diagnosis\n-   Malaria treatment\n-   Referral\n\n+-----------------------------+------------------------+\n| Variable                    | Coding                 |\n+=============================+========================+\n| MEAS_temperature            |                        |\n+-----------------------------+------------------------+\n|                             |                        |\n+-----------------------------+------------------------+\n| TEST_malaria_result         | 0: negative\\           |\n|                             | 1: positive\\           |\n|                             | 2: indeterminate\\      |\n|                             | 95: unreadable result\\ |\n|                             | 98: not sure           |\n+-----------------------------+------------------------+\n| DX_malaria                  | 0: no\\                 |\n|                             | 1: yes                 |\n+-----------------------------+------------------------+\n| RX_antimalarials            | 0: no\\                 |\n|                             | 1: yes                 |\n+-----------------------------+------------------------+\n| MGMT_referral_src_caregiver |                        |\n+-----------------------------+------------------------+\n| MGMT_referral_src_registry  |                        |\n+-----------------------------+------------------------+\n\n### Structure of the data\n\n::: panel-tabset\n#### :pencil2: Exercise 5\n\nExamine the structure of the data, including variable names, labels.\n\n::: callout-tip\n-   Stata: use the [codebook](https://www.stata.com/manuals/dcodebook.pdf) command\n-   R: use the [skim](https://docs.ropensci.org/skimr/reference/skim.html) function from the `skimr` package\n:::\n\n```{r}\n#| echo: fenced\n# Write your code here\n```\n\n#### Stata\n\n```{r}\nRStata::stata(\"codebook MEAS_temperature TEST_malaria_result TEST_malaria_result DX_malaria RX_antimalarials MGMT_referral_src_caregiver MGMT_referral_src_registry\",\n              data.in = stata_df)\n```\n\n#### R\n\n```{r}\ndf %>%\n  skimr::skim(MEAS_temperature,\n              TEST_malaria_result,\n              TEST_malaria_result,\n              DX_malaria,\n              RX_antimalarials,\n              MGMT_referral_src_caregiver,\n              MGMT_referral_src_registry)\n```\n:::\n\n::: panel-tabset\n#### :pencil2: Exercise 3\n\nAdd the following two new variables to data frame `df`\n\n-   MEAS_fever\n-   Fever (temp or history)\n\n::: callout-tip\n-   Stata: use the gen command\n-   R: use the mutate function from the `dplyr` package\n:::\n\n```{r}\n#| echo: fenced\n# Write your code here\n```\n\n#### Stata\n\n#### R\n\n```{r}\n#| echo: fenced\ndf <- df %>%\n  dplyr::mutate(CALC_temperature_measured = !is.na(MEAS_temperature)) %>%\n  dplyr::mutate(CALC_fever = MEAS_temperature >= 37.5) %>%\n  dplyr::mutate(CALC_fever_or_temp = (CLIN_fever == 1) | (CALC_fever == 1))\n```\n\n#### Python\n:::\n\n::: panel-tabset\n#### :pencil2: Exercise 6\n\nDisplay descriptive statistics for the following healthcare provider actions:\n\n::: callout-tip\n-   R: use the [tbl_summary](https://www.danieldsjoberg.com/gtsummary/reference/tbl_summary.html) function from the `gtsummary` package\n:::\n\n```{r}\n#| echo: fenced\n# Write your code here\n```\n\n#### Stata\n\n#### R\n\n```{r}\n#| echo: fenced\ndf %>%\n  dplyr::select(CALC_temperature_measured,\n                CALC_fever,\n                CALC_fever_or_temp,\n                TEST_malaria_result,\n                TEST_malaria_result,\n                DX_malaria,\n                RX_antimalarials,\n                MGMT_referral_src_caregiver,\n                MGMT_referral_src_registry) %>%\n  gtsummary::tbl_summary(missing_text = \"(Missing)\")\n```\n:::\n\n## Number of consultations by facility\n\n::: panel-tabset\n### :pencil2: Exercise 6\n\nPlot the number of consultations by facility in bars, grouped by district.\n\n::: callout-tip\n-   Stata:\n-   R:\n:::\n\n### Stata\n\n```{r}\n#| echo: fenced\nstata_cmd <- '\ngraph bar (count) child_ID, over(CTX_facility_ID, axis(off)) over(CTX_district, relabel(1 \"Kaliua\" 2 \"Sengerema\" 3 \"Tanga\")) nofill ytitle(No. consultations) title(No. consultations by facility)\ngraph export ./images/day02_stata_plot.png, replace\n'\nRStata::stata(stata_cmd,\n              data.in = stata_df)\n```\n\n![](images/day02_stata_plot.png)\n\n### R\n\n```{r}\n#| echo: fenced\ndf %>%\n  dplyr::group_by(CTX_district,\n                  CTX_facility_ID) %>%\n  count() %>% \n  ggplot2::ggplot(aes(x = haven::as_factor(CTX_district),\n                      y = n)) + \n  ggplot2::geom_bar(position = position_dodge2(preserve = \"single\"),\n                    stat=\"identity\") +\n  ggplot2::labs(x = \"\", y = \"No. consultations\") +\n  ggthemes::theme_hc()\n```\n:::\n\n## Fever assessment\n\n-   temp measurement by reported fever; by facility\n\n```{r}\n#| echo: fenced\n# Write here\n```\n\n```{r}\nchisq.test(df$CLIN_fever, df$TEST_malaria_result)\n```\n\n```{r}\n#| echo: fenced\ndf$CTX_facility_ID <- haven::as_factor(df$CTX_facility_ID) \ndf %>%\n  dplyr::filter(CLIN_fever == 1) %>%\n  dplyr::select(MEAS_temperature,\n                CTX_facility_ID) %>%\n  gtsummary::tbl_summary(by = CTX_facility_ID) %>%\n  add_p()\n```\n\n-   also showing 'prevalence' of fever when of whole clinic vs of those who measure to indicate bias\n\n```{r}\n#| echo: fenced\n# Write here\n```\n\n## Malaria tests\n\n-   malaria tests of those with history or measured fever\n\n```{r}\n#| echo: fenced\n# Write here\n```\n\n```{r}\n#| echo: fenced\ntable(df$CALC_fever_or_temp, df$TEST_malaria_result)\n```\n\n```{r}\nchisq.test(df$CALC_fever_or_temp, df$TEST_malaria_result)\n```\n\n```{r}\n#| echo: fenced\ndf$CTX_facility_ID <- haven::as_factor(df$CTX_facility_ID) \ndf %>%\n  dplyr::filter(CALC_fever_or_temp == 1) %>%\n  dplyr::select(TEST_malaria_result,\n                CTX_facility_ID) %>%\n  gtsummary::tbl_summary(by = CTX_facility_ID)\n```\n\n## Malaria treatments\n\n-   malaria diagnoses vs. positive tests vs. treatment.\n\n```{r}\n#| echo: fenced\n# Write here\n```\n\n```{r}\n#| echo: fenced\ndf <- df %>%\n  dplyr::mutate(TEST_malaria_positive = 1* (TEST_malaria_result == 1))\ntable(df$TEST_malaria_result, df$DX_malaria, df$RX_antimalarials) %>% knitr::kable()\n```\n\n```{r}\nchisq.test(df$TEST_malaria_result, df$DX_malaria)\n```\n\n```{r}\nchisq.test(df$TEST_malaria_result, df$RX_antimalarials)\n```\n\n```{r}\n#| echo: fenced\n# df$CTX_facility_ID <- haven::as_factor(df$CTX_facility_ID) \n# df %>%\n#   dplyr::filter(TEST_malaria_positive == 1) %>%\n#   dplyr::select(DX_malaria,\n#                 RX_antimalarials,\n#                 CTX_facility_ID) %>%\n#   gtsummary::tbl_summary(by = CTX_facility_ID)\n```\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","from":"markdown+emoji","output-file":"malaria_case_study_01.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.1.251","bibliography":["references.bib"],"csl":"vancouver.csl","theme":"cosmo","title":":orange_book: Malaria case study - Part 1"},"extensions":{"book":{"multiFile":true}}},"pdf":{"execute":{"fig-width":5.5,"fig-height":3.5,"fig-format":"pdf","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"pdf","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"pdf-engine":"xelatex","standalone":true,"variables":{"graphics":true,"tables":true},"default-image-extension":"pdf","to":"pdf","from":"markdown+emoji","output-file":"malaria_case_study_01.pdf"},"language":{},"metadata":{"block-headings":true,"bibliography":["references.bib"],"csl":"vancouver.csl","documentclass":"scrreprt","title":":orange_book: Malaria case study - Part 1"},"extensions":{"book":{}}}}}